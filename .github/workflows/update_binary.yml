name: Auto Build MRS Rules

on:
  schedule:
    # 每 6 小时运行一次 (北京时间 8:00, 14:00, 20:00, 02:00)
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 下载 Mihomo 内核
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ">>> 下载最新正式版内核 (Compatible)..."
          # 精准匹配 compatible 版本，避免多文件冲突
          gh release download --repo MetaCubeX/mihomo --pattern "*linux-amd64-compatible-v*.gz" --output mihomo.gz
          
          gunzip mihomo.gz
          chmod +x mihomo
          
          # 创建结果存放目录
          mkdir -p RULE-SET
          
          echo ">>> 内核版本："
          ./mihomo -v

      - name: 3. 处理 Hagezi Pro Plus
        run: |
          echo ">>> [1/4] 下载 Hagezi 源文件..."
          curl -sSL "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/pro.plus.txt" -o raw.txt
          
          # 检查源文件是否下载成功
          if [ ! -s raw.txt ]; then
            echo "❌ 下载失败或文件为空！"
            exit 1
          fi

          echo ">>> [2/4] 转换为 YAML 格式..."
          echo "payload:" > hagezi_temp.yaml
          # 自动添加 yaml 格式缩进
          grep -vE '^#|^$' raw.txt | sed "s/^/  - '/; s/$/'/" >> hagezi_temp.yaml
          
          echo ">>> [3/4] 编译为二进制 (.mrs)..."
          # 语法: convert-ruleset <行为> <格式> <输入> <输出>
          ./mihomo convert-ruleset domain yaml hagezi_temp.yaml RULE-SET/hagezi_pro_plus.mrs
          
          echo ">>> [4/4] 验证生成结果"
          ls -lh RULE-SET/hagezi_pro_plus.mrs
          
          # 清理临时文件
          rm raw.txt hagezi_temp.yaml

      - name: 4. 处理 Direct (自动格式化版)
        run: |
          if [ -f "direct.yaml" ]; then
            echo ">>> 发现 direct.yaml，正在标准化格式..."
            
            # 1. 创建临时 YAML 文件，写入头部
            echo "payload:" > direct_temp.yaml
            
            # 2. 读取你的纯文本文件，自动加上 YAML 缩进和引号
            # 逻辑：读取 -> 去掉注释/空行 -> 每行前面加 "  - '" -> 每行后面加 "'"
            grep -vE '^#|^$' direct.yaml | sed "s/^/  - '/; s/$/'/" >> direct_temp.yaml
            
            echo ">>> 生成的临时 YAML 内容预览 (前10行)："
            head -n 10 direct_temp.yaml

            echo ">>> 编译为二进制 (.mrs)..."
            ./mihomo convert-ruleset domain yaml direct_temp.yaml RULE-SET/direct.mrs
            
            echo ">>> 验证生成结果："
            ls -lh RULE-SET/direct.mrs
            
            # 清理临时文件
            rm direct_temp.yaml
          else
            echo "⚠️ 警告：根目录下没找到 direct.yaml，跳过此步骤。"
          fi

      - name: 5. 提交并上传
        run: |
          # 删除内核文件，保持仓库干净
          rm mihomo

          # 配置 Git 身份
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加生成的 mrs 文件
          git add RULE-SET/*.mrs
          
          # 提交 (如果文件没变化，git commit 会自动退出，不会报错)
          git commit -m "Auto-update rules binaries [skip ci]" || exit 0
          git push
